#!/usr/bin/env -S deno run --quiet --allow-all --unstable

import {
  $,
} from 'https://deno.land/x/deno_dx@0.2.0/mod.ts';
import yargs from 'https://deno.land/x/yargs@v17.0.1-deno/deno.ts';
import { getDownloadLink } from './scripts/gogo-stream.ts';

const argv =
  yargs(Deno.args)
    .usage('Usage: download-gogo-stream-video $GOGO_STREAM_URL')

    .alias('e', 'echo')
    .nargs('e', 0)
    .boolean('e')
    .describe('e', 'If set returns the URL instead of downloading it')

    // @ts-ignore: For some reason it exists but isn't picked up
    .argv
  ;

const [gogoStreamUrl] = argv._;
const url = await getDownloadLink(gogoStreamUrl);

if (!url) {
  Deno.exit(1);
}

if (argv.echo) {
  await Deno.stdout.write(new TextEncoder().encode(url));
} else {
  await $`youtube-dl --referer '${gogoStreamUrl}' '${url}'`
}
